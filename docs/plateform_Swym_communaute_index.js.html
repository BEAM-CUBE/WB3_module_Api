<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: plateform/Swym/communaute/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: plateform/Swym/communaute/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {
  _httpCallAuthenticated,
  _3dswym_get_version,
  _3DSwym_getIdeaStatus,
} from "@/plugins";
import { mainStore } from "@/store";

export function _3dSwim_getAllCommunities(
  token,
  onDone = undefined,
  onError = undefined,
) {
  const store = mainStore();
  const { _3DSwym } = store;
  //FIXME - faire la gestion des limits et des pages
  // 1 faire un 1er appel pour avoir le nombre de résultats
  // 2 par defaut la limit est de 10, et peu aller à 128, au delà on passe sur une autre page
  const URL = `${_3DSwym}/api/community/listmycommunities/limit/100`;

  const communautes = [];

  _httpCallAuthenticated(URL, {
    method: "GET",
    headers: {
      "X-DS-SWYM-CSRFTOKEN": token,
    },
    onComplete(response, headers, xhr) {
      const info = JSON.parse(response);
      const _communities = info.result;
      let count = 0;
      console.log("_3dSwim_getAllCommunities / resp", info);
      // store.updateAllCommunities(_communities);
      _communities.forEach((commu) => {
        const com = {
          description: commu.description,
          id: commu.id,
          title: commu.title,
          owner: commu.owner,
          role: commu.role,
          access: commu.access,
        };

        _3dSwim_getMembersCommunity(
          token,
          commu.id,
          (data) => {
            count++;
            com["members"] = data;
            communautes.push(com);
            if (count === _communities.length) {
              if (onDone) onDone(communautes);
              console.log("communautes => ", communautes);
              store.updateAllCommunities(communautes);
            }
          },
          (err) => onError(err),
        );
      });
    },
    if(onDone) {
      onDone(communautes);
    },
    onFailure(response) {
      if (onError) onError(response);
    },
  });
}

export function _3dSwim_getMembersCommunity(tk, idCommu, onDone, onError) {
  const store = mainStore();
  const { _3DSwym } = store;
  const URL = `${_3DSwym}/api/community/listmembers`;

  const datas = {
    params: {
      page: 1,
      limit: 50, // de 1 à 128
      community_id: idCommu,
    },
  };

  _httpCallAuthenticated(URL, {
    method: "POST",
    headers: {
      "Content-type": "application/json;charset=UTF-8",
      Accept: "application/json",
      "X-DS-SWYM-CSRFTOKEN": tk,
    },
    data: JSON.stringify(datas),
    type: "json",
    onComplete(response, headers, xhr) {
      const info = response;
      if (onDone) onDone(info);
    },
    onFailure(response) {
      if (onError) onError(response);
    },
  });
}

export function _3DSwym_getIdeaStatusMaturity(
  onDone = undefined,
  onError = undefined,
) {
  const store = mainStore();
  const { _3DSwym } = store;

  const URL = `${_3DSwym}/api/v2/communities/${"YXdA5x4DSUKtlAi2wmnyTA"}/ideas/statuses`;
  _3dswym_get_version((token) => {
    _httpCallAuthenticated(URL, {
      method: "GET",
      headers: {
        "Content-type": "application/json;charset=UTF-8",
        Accept: "application/json",
        "X-DS-SWYM-CSRFTOKEN": token.result.ServerToken,
      },

      onComplete(response) {
        const info = JSON.parse(response);
        console.log("1 SWYMIdea status ", info);
        if (onDone) onDone(info);
      },
      onFailure(response) {
        if (onError) onError(response);
      },
    });
  });
}

// TEST
const contentMSG = {
  receipt: ["c00005701637"], // Liste des personnes à qui envoyer le message
  msg: "TESTS Beam ³ DEV, Happy new year ! ヾ(⌐■_■)ノ♪", // Message à envoyer
};

// CREATION DE MESSAGES DIRECT OU INSTANTANÉ
/**
 * @description
 * La fonction `_3dSwym_buildDirectMessage` envoie un message direct à un utilisateur dans une
 * application 3D Swym.
 * @param {Object} [datas] - Le paramètre `datas` est un objet qui contient les propriétés suivantes:
 * @property {ArrayOfString} `receipt` est un tableau de chaines de caractères correspondant aux identifiants des utilisateurs à qui envoyer le message accessible par dans `__listAllContacts.hits` (login) depuis le store.
 * @property {String} 'msg'
 */
export function _3dSwym_buildDirectMessage(datas = contentMSG) {
  const store = mainStore();
  const { _3DSwym, __listAllContacts, currentUser } = store;
  console.log("__listAllContacts", __listAllContacts.hits);
  const _URL = `${_3DSwym}/api/directmessages`;

  const _data = {
    users: [currentUser.login].concat(datas.receipt),
  };

  const MSGData = {
    id_msg: "",
    senderId: currentUser.login,
    senderName: `${currentUser.first_name} ${currentUser.last_name}`,
    msg: formatedMessage(datas.msg),
  };
  let otherCommunity = false;
  _3dSwym_findCommunityToInstantMSG(
    _data.users,
    (rep) => {
      console.log("_3dSwym_findCommunityToInstantMSG callback rep", rep);
      if (rep !== undefined) {
        MSGData["id_msg"] = rep.id;
        otherCommunity = true;
        _3dSwym_sendMessageData(MSGData);
      }
    },
    (err) => {
      otherCommunity = false;
      console.log("_3dSwym_findCommunityToInstantMSG callback", err);
      MSGData["id_msg"] = "";
    },
  );

  if (otherCommunity === false) {
    setTimeout(() => {
      if (otherCommunity === false) {
        _3dswym_get_version((token) => {
          _httpCallAuthenticated(_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
              "X-DS-SWYM-CSRFTOKEN": token.result.ServerToken,
            },
            data: JSON.stringify(_data),
            type: "json",
            onComplete(response, headers, xhr) {
              const info = response;
              info["reponse"] = JSON.parse(xhr.response);
              info["status"] = xhr.status;
              console.log("✅ _3dSwym_sendDirectMessage => ", info);

              MSGData["id_msg"] = info.result.id;
              _3dSwym_sendMessageData(MSGData);
            },
            onFailure(response, headers, xhr) {
              const info = response;
              info["msg"] = headers.errormsg;
              info["status"] = headers.status;
              console.log("❌ sendDirectMessage => ", info);

              // ! Il peut y avoir une réponse positive dans l'erreur au cas ou une communication est déjà lancé (status code 409).
              //! Si oui on refait un appel
              // if (Object.keys(headers).includes("result")) {
              //   // MSGData["id_msg"] = headers.result.id;
              //   MSGData["tk"] = token.result.ServerToken;
              //   console.log("🚀 _3dSwym_sendDirectMessageLite 409 => ");
              //   _3dSwym_sendDirectMessageFindCommunity();
              //   // _3dSwym_sendDirectMessageData(MSGData);
              // }
            },
          });
        });
      }
    }, 500);
  }
}

/**
 * La fonction `_3dSwym_findCommunityToInstantMSG` permet de trouver une communauté pour envoyer un
 * message instantané dans une application 3D Swym.
 * @param datas - Le paramètre `datas` est un tableau qui contient les données à utiliser pour trouver une communauté pour envoyer un message instantané.
 *
 * @param onDone - Le paramètre `onDone` est une fonction de rappel qui sera appelée lorsque
 * l'opération sera terminée avec succès. Il faut un argument, qui est le résultat de l’opération.
 * @param onError - Le paramètre `onError` est une fonction de rappel qui sera appelée s'il y a une
 * erreur lors de l'exécution de la fonction `_3dSwym_findCommunityToInstantMSG`. Il est utilisé pour gérer toutes les erreurs qui se produisent et fournir une gestion des erreurs ou des messages d'erreur appropriés à l'utilisateur.
 *
 */
function _3dSwym_findCommunityToInstantMSG(datas, onDone, onError) {
  const store = mainStore();
  const { _3DSwym } = store;

  const URL = `${_3DSwym}/api/directmessages/lite?with_favorites=false`;
  _3dswym_get_version((token) => {
    _httpCallAuthenticated(URL, {
      method: "GET",
      headers: {
        Accept: "application/json,text/javascript,*/*",
        "X-DS-SWYM-CSRFTOKEN": token.result.ServerToken,
      },
      onComplete(response) {
        const info = JSON.parse(response);
        console.log("_3dSwym_sendDirectMessageFindCommunity ", info);

        const infoSortedByLengths = [];

        info.result.forEach((com) => {
          com.users = com.users.sort((a, b) => {
            return a.login.localeCompare(b.login);
          });
          if (com.users.length === datas.length) {
            infoSortedByLengths.push(com);
          }
        });
        const sortedDatas = datas.sort();

        const _datas = infoSortedByLengths.find((com) => {
          const logins = [];
          com.users.forEach((user) => {
            logins.push(user.login);
          });
          return JSON.stringify(logins) === JSON.stringify(sortedDatas);
        });

        if (onDone &amp;&amp; _datas !== undefined) {
          onDone(_datas);
        } else if (onError || _datas === undefined) {
          onError(_datas);
        }
      },
      onFailure(response) {
        const info = response;
        info["msg"] = headers.errormsg;
        info["errCode"] = headers.errorcode;
        console.log("❌ sendDirectMessageLite => ", info);
      },
    });
  });
}

/**
 * @description
 * La fonction `_3dSwym_sendDirectMessageData` envoie un message direct avec le contenu fourni à l'aide
 * de l'API 3DSwym.
 * @param content - Le paramètre `content` est un objet qui contient les propriétés suivantes:
 */
function _3dSwym_sendMessageData(content) {
  const store = mainStore();
  const { _3DSwym } = store;
  const URL = {
    base: _3DSwym,
    uri: "/api/community",
    id_msg: `${content.id_msg}`,
    endUri: "/instantmessages",
  };

  const url = `${URL.base}${URL.uri}/${URL.id_msg}${URL.endUri}`;

  const datas = {
    author: { login: content.senderId, displayName: content.senderName },
    accessState: null,
    commentUri: null,
    comments: null,
    endorsements: null,
    moderationState: null,
    parentCommentUri: null,
    richMessage: content.msg,
  };
  console.log("_3dSwym_sendDirectMessageData url ", url);
  _3dswym_get_version((token) => {
    _httpCallAuthenticated(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json",
        "X-DS-SWYM-CSRFTOKEN": token.result.ServerToken,
      },
      data: JSON.stringify(datas),
      type: "json",
      onComplete(response, headers, xhr) {
        const info = response;
        info["status"] = xhr.status;
        info["response"] = JSON.parse(xhr.response);
        console.log("✅ _3dSwym_sendDirectMessageData => ", info);
      },
      onFailure(response, headers) {
        const info = response;
        info["msg"] = headers.errormsg;
        info["errCode"] = headers.errorcode;
        console.log("❌ sendDirectMessage => ", info);
      },
    });
  });
}

function formatedMessage(message) {
  const _dates = new Date().toLocaleDateString();
  const time = new Date().toLocaleTimeString();
  return `&lt;p>${message} &lt;/p>
  &lt;br/>
  &lt;hr/>
  &lt;p>&lt;u>envoyer :&lt;/u>Le &lt;b>${_dates} à ${time}&lt;/b>&lt;/p>`;
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#_3DSpace_Create_Doc">_3DSpace_Create_Doc</a></li><li><a href="global.html#_3DSpace_csrf">_3DSpace_csrf</a></li><li><a href="global.html#_3DSpace_download_doc">_3DSpace_download_doc</a></li><li><a href="global.html#_3DSpace_download_multidoc">_3DSpace_download_multidoc</a></li><li><a href="global.html#_3DSpace_file_update">_3DSpace_file_update</a></li><li><a href="global.html#_3DSpace_file_update_csr">_3DSpace_file_update_csr</a></li><li><a href="global.html#_3DSpace_file_url">_3DSpace_file_url</a></li><li><a href="global.html#_3DSpace_file_url_csr">_3DSpace_file_url_csr</a></li><li><a href="global.html#_3DSpace_get_csrf">_3DSpace_get_csrf</a></li><li><a href="global.html#_3DSpace_get_docInfo">_3DSpace_get_docInfo</a></li><li><a href="global.html#_3DSpace_get_downloadTicket_multidoc">_3DSpace_get_downloadTicket_multidoc</a></li><li><a href="global.html#_3DSpace_get_securityContexts">_3DSpace_get_securityContexts</a></li><li><a href="global.html#_3DSpace_lifecycle_changeRevision">_3DSpace_lifecycle_changeRevision</a></li><li><a href="global.html#_3DSpace_lifecycle_changeState">_3DSpace_lifecycle_changeState</a></li><li><a href="global.html#_3DSpace_lifecycle_getGraph">_3DSpace_lifecycle_getGraph</a></li><li><a href="global.html#_3DSpace_lifecycle_getNextRevision">_3DSpace_lifecycle_getNextRevision</a></li><li><a href="global.html#_3DSpace_lifecycle_getNextStates">_3DSpace_lifecycle_getNextStates</a></li><li><a href="global.html#_3DSwym_getAllNews">_3DSwym_getAllNews</a></li><li><a href="global.html#_3DSwym_getFamiliarPeople">_3DSwym_getFamiliarPeople</a></li><li><a href="global.html#_3DSwym_getSWYMIdea">_3DSwym_getSWYMIdea</a></li><li><a href="global.html#_3DSwym_get_AllSWYMIdeas">_3DSwym_get_AllSWYMIdeas</a></li><li><a href="global.html#_3DSwym_get_currentUser">_3DSwym_get_currentUser</a></li><li><a href="global.html#_3DSwym_get_findUser">_3DSwym_get_findUser</a></li><li><a href="global.html#_3DSwym_get_version">_3DSwym_get_version</a></li><li><a href="global.html#_3dSwym_buildDirectMessage">_3dSwym_buildDirectMessage</a></li><li><a href="global.html#_3dSwym_deleteIdea">_3dSwym_deleteIdea</a></li><li><a href="global.html#_3dSwym_findCommunityToInstantMSG">_3dSwym_findCommunityToInstantMSG</a></li><li><a href="global.html#_3dSwym_postIdea">_3dSwym_postIdea</a></li><li><a href="global.html#_3dSwym_sendMessageData">_3dSwym_sendMessageData</a></li><li><a href="global.html#_getPlateformInfos">_getPlateformInfos</a></li><li><a href="global.html#_getPlatformServices">_getPlatformServices</a></li><li><a href="global.html#_httpCallAuthenticated">_httpCallAuthenticated</a></li><li><a href="global.html#_setDraggable">_setDraggable</a></li><li><a href="global.html#_setDroppable">_setDroppable</a></li><li><a href="global.html#_setupTagger">_setupTagger</a></li><li><a href="global.html#compass_getListAdditionalApps">compass_getListAdditionalApps</a></li><li><a href="global.html#createUserGroups">createUserGroups</a></li><li><a href="global.html#dataMixing">dataMixing</a></li><li><a href="global.html#deleteUserGroups">deleteUserGroups</a></li><li><a href="global.html#findAdresse">findAdresse</a></li><li><a href="global.html#getActiveServices">getActiveServices</a></li><li><a href="global.html#getAllContextSecurity">getAllContextSecurity</a></li><li><a href="global.html#getCSRFToken">getCSRFToken</a></li><li><a href="global.html#getCommunes">getCommunes</a></li><li><a href="global.html#getComplementUG">getComplementUG</a></li><li><a href="global.html#getDataFrom3DSpace">getDataFrom3DSpace</a></li><li><a href="global.html#getDataFromGouvFr">getDataFromGouvFr</a></li><li><a href="global.html#getDatasByTenant">getDatasByTenant</a></li><li><a href="global.html#getDatasFrom3DSpace">getDatasFrom3DSpace</a></li><li><a href="global.html#getDownloadDocument">getDownloadDocument</a></li><li><a href="global.html#getUserGroupsList">getUserGroupsList</a></li><li><a href="global.html#getUsersGroupRules">getUsersGroupRules</a></li><li><a href="global.html#get_3DSpace_csrf">get_3DSpace_csrf</a></li><li><a href="global.html#patchUserGroups">patchUserGroups</a></li><li><a href="global.html#patchUserGroupsControl">patchUserGroupsControl</a></li><li><a href="global.html#pushDataIn3DSpace">pushDataIn3DSpace</a></li><li><a href="global.html#readUserGroupControl">readUserGroupControl</a></li><li><a href="global.html#updateEvent">updateEvent</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Fri Jan 12 2024 10:06:45 GMT+0100 (heure normale d’Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
